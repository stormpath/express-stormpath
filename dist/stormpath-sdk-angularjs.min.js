/**
 * stormpath-sdk-angularjs
 * Copyright Stormpath, Inc. 2015
 * 
 * @version v0.3.0-dev-2015-04-02
 * @link https://github.com/stormpath/stormpath-sdk-angularjs
 * @license Apache-2.0
 */
"undefined"!=typeof module&&"undefined"!=typeof exports&&module.exports===exports&&(module.exports="ui.router"),function(a,b){"use strict";b.module("stormpath",["stormpath.CONFIG","stormpath.auth","stormpath.userService"]).provider("$stormpath",[function(){this.$get=["$user","$state","$cookieStore","STORMPATH_CONFIG","$rootScope",function(a,b,c,d,e){function f(){var a=new h;return this.encodeUrlForm=a.encode.bind(a),this}function g(b){var c=b;return c&&c.authorize&&c.authorize.group?a.currentUser.inGroup(c.authorize.group):(console.error("Unknown authorize configuration for spStateConfig",b),!1)}function h(){return this.delimiter="&",this.arrayPrefixGenerators={brackets:function(a){return a+"[]"},indices:function(a,b){return a+"["+b+"]"},repeat:function(a){return a}},this}return f.prototype.stateChangeInterceptor=function(){e.$on("$stateChangeStart",function(c,f,h){var i=f.sp||{};!i.authenticate&&!i.authorize||a.currentUser?i.waitForUser&&null===a.currentUser?(c.preventDefault(),a.get()["finally"](function(){b.go(f.name,h)})):a.currentUser&&i.authorize&&(g(i)||(c.preventDefault(),e.$broadcast(d.STATE_CHANGE_UNAUTHORIZED,f,h))):(c.preventDefault(),a.get().then(function(){i.authorize?g(i)?b.go(f.name,h):e.$broadcast(d.STATE_CHANGE_UNAUTHORIZED,f,h):b.go(f.name,h)},function(){e.$broadcast(d.STATE_CHANGE_UNAUTHENTICATED,f,h)}))})},f.prototype.uiRouter=function(a){var c=this;a="object"==typeof a?a:{},this.stateChangeInterceptor(),a.loginState&&(c.unauthenticatedWather=e.$on(d.STATE_CHANGE_UNAUTHENTICATED,function(f,g,h){c.postLogin={toState:g,toParams:h},b.go(a.loginState),a.autoRedirect!==!1&&(c.authWatcher=e.$on(d.AUTHENTICATION_SUCCESS_EVENT_NAME,function(){c.authWatcher(),c.postLogin&&b.go(c.postLogin.toState,c.postLogin.toParams).then(function(){c.postLogin=null})}))})),a.defaultPostLoginState&&(c.defaultRedirectStateWatcher=e.$on(d.AUTHENTICATION_SUCCESS_EVENT_NAME,function(){c.postLogin||b.go(a.defaultPostLoginState)}))},h.prototype.stringify=function(a,b,c){if(a instanceof Date?a=a.toISOString():null===a&&(a=""),"string"==typeof a||"number"==typeof a||"boolean"==typeof a)return[encodeURIComponent(b)+"="+encodeURIComponent(a)];var d=[];if("undefined"==typeof a)return d;for(var e=Object.keys(a),f=0,g=e.length;g>f;++f){var h=e[f];d=d.concat(Array.isArray(a)?this.stringify(a[h],c(b,h),c):this.stringify(a[h],b+"["+h+"]",c))}return d},h.prototype.encode=function(a,b){b=b||{};var c="undefined"==typeof b.delimiter?this.delimiter:b.delimiter,d=[];if("object"!=typeof a||null===a)return"";var e;e=b.arrayFormat in this.arrayPrefixGenerators?b.arrayFormat:"indices"in b?b.indices?"indices":"repeat":"indices";for(var f=this.arrayPrefixGenerators[e],g=Object.keys(a),h=0,i=g.length;i>h;++h){var j=g[h];d=d.concat(this.stringify(a[j],j,f))}return d.join(c)},new f}]}]).run(["$rootScope","$user","STORMPATH_CONFIG",function(a,b,c){a.user=b.currentUser||null,b.get()["finally"](function(){a.user=b.currentUser}),a.$on(c.GET_USER_EVENT,function(){a.user=b.currentUser}),a.$on(c.SESSION_END_EVENT,function(){a.user=b.currentUser})}]).directive("ifUser",["$user","$rootScope",function(a,b){return{link:function(a,c){b.$watch("user",function(a){a&&a.href?c.show():c.hide()})}}}]).directive("ifNotUser",["$user","$rootScope",function(a,b){return{link:function(a,c){b.$watch("user",function(a){a&&a.href?c.hide():c.show()})}}}]).directive("ifUserInGroup",["$user","$rootScope",function(a,b){return{link:function(c,d,e){b.$watch("user",function(){a.currentUser&&a.currentUser.inGroup(e.ifUserInGroup)?d.show():d.hide()})}}}]).directive("ifUserNotInGroup",["$user","$rootScope",function(a,b){return{link:function(c,d,e){b.$watch("user",function(){a.currentUser&&a.currentUser.inGroup(e.ifUserNotInGroup)?d.hide():d.show()})}}}]).directive("whileResolvingUser",["$user","$rootScope",function(a,b){return{link:function(c,d){b.$watch("user",function(){a.currentUser||a.currentUser===!1?d.hide():d.show()})}}}]).directive("ifUserStateKnown",["$user","$rootScope",function(a,b){return{link:function(c,d){b.$watch("user",function(){a.currentUser||a.currentUser===!1?d.show():d.hide()})}}}]).directive("ifUserStateUnknown",["$user","$rootScope",function(a,b){return{link:function(c,d){b.$watch("user",function(){null===a.currentUser?d.show():d.hide()})}}}]).directive("spLogout",["$auth",function(a){return{link:function(b,c){c.on("click",function(){a.endSession()})}}}]),b.module("stormpath.auth",["stormpath.CONFIG"]).config(["$injector","STORMPATH_CONFIG",function(a,b){var c={$get:["$http","$user","$rootScope","$spFormEncoder",function(a,c,d,e){function f(){return this}function g(){return c.get()}function h(a){d.$broadcast(b.AUTHENTICATION_SUCCESS_EVENT_NAME,a)}function i(a){d.$broadcast(b.AUTHENTICATION_FAILURE_EVENT_NAME,a)}return f.prototype.authenticate=function(c){var d=a(e.formPost({url:b.AUTHENTICATION_ENDPOINT,method:"POST",withCredentials:!0,data:c,params:{grant_type:"password"}})),f=d.then(g).then(h);return d["catch"](i),f},f.prototype.endSession=function(){var c=a.get(b.DESTROY_SESSION_ENDPOINT);return c.then(function(){d.$broadcast(b.SESSION_END_EVENT)},function(a){console.error("logout error",a)}),c},new f}]};a.get("$provide").provider(b.AUTH_SERVICE_NAME,c)}]),b.module("stormpath.CONFIG",[]).constant("STORMPATH_CONFIG",{AUTHENTICATION_ENDPOINT:"/oauth/token",CURRENT_USER_URI:"/api/users/current",USER_COLLECTION_URI:"/api/users",DESTROY_SESSION_ENDPOINT:"/logout",RESEND_EMAIL_VERIFICATION_ENDPOINT:"/api/verificationEmails",EMAIL_VERIFICATION_ENDPOINT:"/api/emailVerificationTokens",PASSWORD_RESET_TOKEN_COLLECTION_ENDPOINT:"/api/passwordResetTokens",GET_USER_EVENT:"$currentUser",SESSION_END_EVENT:"$sessionEnd",UNAUTHORIZED_EVENT:"unauthorized",LOGIN_STATE_NAME:"login",FORBIDDEN_STATE_NAME:"forbidden",AUTHENTICATION_SUCCESS_EVENT_NAME:"$authenticated",AUTHENTICATION_FAILURE_EVENT_NAME:"$authenticationFailure",AUTH_SERVICE_NAME:"$auth",NOT_LOGGED_IN_EVENT:"$notLoggedin",STATE_CHANGE_UNAUTHENTICATED:"$stateChangeUnauthenticated",STATE_CHANGE_UNAUTHORIZED:"$stateChangeUnauthorized",FORM_CONTENT_TYPE:""}),b.module("stormpath").controller("SpEmailVerificationCtrl",["$scope","$stateParams","$user",function(a,b,c){a.showVerificationError=!1,a.verifying=!1,a.reVerificationSent=!1,a.needsReVerification=!1,a.resendFailed=!1,a.formModel={username:""},b.sptoken?(a.verifying=!0,c.verify({sptoken:b.sptoken}).then(function(){a.verified=!0})["catch"](function(){a.needsReVerification=!0,a.showVerificationError=!0})["finally"](function(){a.verifying=!1})):(a.needsReVerification=!0,a.showVerificationError=!0),a.submit=function(){a.posting=!0,a.resendFailed=!1,a.showVerificationError=!1,c.resendVerificationEmail({login:a.formModel.username}).then(function(){a.reVerificationSent=!0})["catch"](function(){a.resendFailed=!0})["finally"](function(){a.posting=!1})}}]).directive("spEmailVerification",function(){return{templateUrl:function(a,b){return b.templateUrl||"spEmailVerification.tpl.html"},controller:"SpEmailVerificationCtrl"}}),b.module("stormpath").provider("$spFormEncoder",[function(){this.$get=["STORMPATH_CONFIG",function(a){function b(){var a=new c;return this.encodeUrlForm=a.encode.bind(a),this}function c(){return this.delimiter="&",this.arrayPrefixGenerators={brackets:function(a){return a+"[]"},indices:function(a,b){return a+"["+b+"]"},repeat:function(a){return a}},this}return b.prototype.formPost=function(b){if("application/json"!==a.FORM_CONTENT_TYPE){var c=b.headers?b.headers:b.headers={};c["Content-Type"]="application/x-www-form-urlencoded",b.data=this.encodeUrlForm(b.data)}return b},c.prototype.stringify=function(a,b,c){if(a instanceof Date?a=a.toISOString():null===a&&(a=""),"string"==typeof a||"number"==typeof a||"boolean"==typeof a)return[encodeURIComponent(b)+"="+encodeURIComponent(a)];var d=[];if("undefined"==typeof a)return d;for(var e=Object.keys(a),f=0,g=e.length;g>f;++f){var h=e[f];d=d.concat(Array.isArray(a)?this.stringify(a[h],c(b,h),c):this.stringify(a[h],b+"["+h+"]",c))}return d},c.prototype.encode=function(a,b){b=b||{};var c="undefined"==typeof b.delimiter?this.delimiter:b.delimiter,d=[];if("object"!=typeof a||null===a)return"";var e;e=b.arrayFormat in this.arrayPrefixGenerators?b.arrayFormat:"indices"in b?b.indices?"indices":"repeat":"indices";for(var f=this.arrayPrefixGenerators[e],g=Object.keys(a),h=0,i=g.length;i>h;++h){var j=g[h];d=d.concat(this.stringify(a[j],j,f))}return d.join(c)},new b}]}]),b.module("stormpath").controller("SpLoginFormCtrl",["$scope","$auth",function(a,b){a.formModel={username:"",password:""},a.posting=!1,a.submit=function(){a.posting=!0,a.error=null,b.authenticate(a.formModel)["catch"](function(b){a.posting=!1,a.error=b.data.errorMessage})}}]).directive("spLoginForm",function(){return{templateUrl:function(a,b){return b.templateUrl||"spLoginForm.tpl.html"},controller:"SpLoginFormCtrl"}}),b.module("stormpath").controller("SpPasswordResetRequestCtrl",["$scope","$stateParams","$user",function(a,b,c){a.sent=!1,a.posting=!1,a.formModel={username:""},a.requestFailed=!1,a.submit=function(){a.posting=!0,a.requestFailed=!1,c.passwordResetRequest({username:a.formModel.username}).then(function(){a.sent=!0})["catch"](function(){a.requestFailed=!0})["finally"](function(){a.posting=!1})}}]).controller("SpPasswordResetCtrl",["$scope","$stateParams","$user",function(a,b,c){var d=b.sptoken;a.showVerificationError=!1,a.verifying=!1,a.verified=!1,a.posting=!1,a.reset=!1,a.error=null,a.resendFailed=!1,a.formModel={password:"",confirmPassword:""},d?(a.verifying=!0,c.verifyPasswordResetToken(d).then(function(){a.verified=!0})["catch"](function(){a.showVerificationError=!0})["finally"](function(){a.verifying=!1})):a.showVerificationError=!0,a.submit=function(){return a.formModel.password!==a.formModel.confirmPassword?void(a.error="Passwords do not match"):(a.posting=!0,a.error=null,a.showVerificationError=!1,void c.resetPassword(d,{password:a.formModel.password}).then(function(){a.reset=!0})["catch"](function(b){a.error=b.data.errorMessage})["finally"](function(){a.posting=!1}))}}]).directive("spPasswordResetRequestForm",function(){return{templateUrl:function(a,b){return b.templateUrl||"spPasswordResetRequestForm.tpl.html"},controller:"SpPasswordResetRequestCtrl"}}).directive("spPasswordResetForm",function(){return{templateUrl:function(a,b){return b.templateUrl||"spPasswordResetForm.tpl.html"},controller:"SpPasswordResetCtrl"}}),b.module("stormpath").controller("SpRegistrationFormCtrl",["$scope","$user","$auth","$state",function(a,b,c,d){a.formModel="object"==typeof a.formModel?a.formModel:{givenName:"",surname:"",email:"",password:""},a.created=!1,a.enabled=!1,a.creating=!1,a.authenticating=!1,a.submit=function(){a.creating=!0,a.error=null,b.create(a.formModel).then(function(b){a.created=!0,a.enabled=b,b&&a.autoLogin?(a.authenticating=!0,c.authenticate({username:a.formModel.email,password:a.formModel.password}).then(function(){a.postLoginState&&d.go(a.postLoginState)})["catch"](function(b){a.error=b.data.errorMessage})["finally"](function(){a.authenticating=!1,a.creating=!1})):a.creating=!1})["catch"](function(b){a.creating=!1,a.error=b.data.errorMessage})}}]).directive("spRegistrationForm",function(){return{templateUrl:function(a,b){return b.templateUrl||"spRegistrationForm.tpl.html"},controller:"SpRegistrationFormCtrl",link:function(a,b,c){a.autoLogin="true"===c.autoLogin,a.postLoginState=c.postLoginState||""}}}),b.module("stormpath.userService",["stormpath.CONFIG"]).provider("$user",[function(){function a(a){var b=this;Object.keys(a).map(function(c){b[c]=a[c]})}a.prototype.inGroup=function(a){return this.groups.filter(function(b){return b.name===a}).length>0},this.$get=["$q","$http","STORMPATH_CONFIG","$rootScope","$spFormEncoder",function(b,c,d,e,f){function g(){return this.cachedUserOp=null,this.currentUser=null,this}function h(a){e.$broadcast(d.GET_USER_EVENT,a)}function i(){e.$broadcast(d.NOT_LOGGED_IN_EVENT)}g.prototype.create=function(a){var e=b.defer();return c(f.formPost({url:d.USER_COLLECTION_URI,method:"POST",data:a})).then(function(a){e.resolve(201===a.status)},e.reject),e.promise},g.prototype.get=function(){var e=b.defer(),f=this;return f.cachedUserOp?f.cachedUserOp.promise:null!==f.currentUser&&f.currentUser!==!1?(e.resolve(f.currentUser),e.promise):(f.cachedUserOp=e,c.get(d.CURRENT_USER_URI).then(function(b){f.cachedUserOp=null,f.currentUser=new a(b.data),h(f.currentUser),e.resolve(f.currentUser)},function(a){f.currentUser=!1,401===a.status&&i(),f.cachedUserOp=null,e.reject(a)}),e.promise)},g.prototype.resendVerificationEmail=function(a){return c(f.formPost({method:"POST",url:d.RESEND_EMAIL_VERIFICATION_ENDPOINT,data:a}))},g.prototype.verify=function(a){return c(f.formPost({method:"POST",url:d.EMAIL_VERIFICATION_ENDPOINT,data:a}))},g.prototype.verifyPasswordResetToken=function(a){return c.get(d.PASSWORD_RESET_TOKEN_COLLECTION_ENDPOINT+"/"+a)},g.prototype.passwordResetRequest=function(a){return c(f.formPost({method:"POST",url:d.PASSWORD_RESET_TOKEN_COLLECTION_ENDPOINT,data:a}))},g.prototype.resetPassword=function(a,b){return c(f.formPost({method:"POST",url:d.PASSWORD_RESET_TOKEN_COLLECTION_ENDPOINT+"/"+a,data:b}))};var j=new g;return e.$on(d.SESSION_END_EVENT,function(){j.currentUser=!1}),j}]}])}(window,window.angular);